# ComicSmith for macOS — Technical Design (`architecture.md`)

**Status:** Draft 0.1 • Scope covers implemented scaffolds + full target architecture  
**Audience:** Engineering, Product, and QA for ComicSmith (macOS app)  
**Core Principles:** Chat‑first · Page‑first · Comics‑native · Deterministic state · Clear modes · Offline‑safe

---

## 0) Goals & Non‑Goals

### Goals
- Ship a **macOS SwiftUI** app for **comic script authoring** with four content modes:
  1) **Issue** (manage pages)  
  2) **Page** (manage panels)  
  3) **Panel** (edit one panel)  
  4) **References** (All + Detail for characters/locations/props)
- Chat powered by **Gemini Flash 2.5 (text)** with **function tools** to mutate the model.
- All images (page thumbnails, panel roughs, reference portraits) generated by **Gemini Flash 2.5 Image** with explicit **Generating…** states.
- **Always‑on Script** pane that is **live, editable, and structure‑aware**.
- **No lock mode** (everything is editable; we use guardrails, previews, and Undo).
- Deterministic, file‑backed project model (human‑readable YAML/JSON).

### Non‑Goals (for v1)
- Final page layout/lettering or DTP-grade typography.  
- Multi‑user realtime collaboration.  
- Full asset pipeline for final art (we generate **rough** visuals only).

---

## 1) System Overview

```
+----------------------+       +--------------------+      +-------------------------+
|   SwiftUI App (UI)   | <---> |  Core Domain Model | <--> | Persistence (YAML/JSON) |
|  Chat | Content |Scr |       |  Issue/Page/Panel  |      |  + Assets cache (imgs)  |
+----------------------+       +--------------------+      +-------------------------+
         |     ^                         |
         v     |                         v
   ChatOrchestrator                 ImageGenQueue
 (Gemini Flash 2.5 text)       (Gemini Flash 2.5 Image)
         |     ^                         ^
         v     |                         |
     ToolRegistry  <---------------------+
 (function tools)    (tools enqueue image jobs; model changes trigger UI)
```

**Determinism:** The **Domain Model** (Issue → Pages → Panels → Balloons + References) is the single source of truth. Chat, Script, and Content mutate it via a narrow tool surface. UI renders from it. Persistence snapshots it. Images are cached by **content hash** derived from model state.

---

## 2) Modules & Responsibilities

### 2.1 UI Layer (SwiftUI)
- **Panes:** `ChatView`, `ContentView` (sub‐modes), `ScriptView`.
- **Windowing:** panes can be docked, tabbed, or torn off; layouts persist per project.
- **Mode Picker:** `Issue | Page | Panel | Refs` (Refs → All by default; Detail on selection).
- **Follow Focus:** Script auto‑scrolls to current Page/Panel unless disabled.

**Implemented in demo:**
- `RootSplitView` with segmented mode picker and an **Images: n in progress** toolbar counter.
- `IssueView`, `PageView`, `PanelView`, `ReferencesAllView`, `ReferenceDetailView`.
- Page Mode shows **reference chips** and **⚠ continuity badges**.
- Panel Mode supports **balloons** and **reference tagging** (instant apply).

### 2.2 Domain Model
Swift types (scaffolded in `ComicSmithCore`):

```swift
struct Balloon { id, kind, speaker?, text, order }
struct Panel   { id, description, role, balloons[], characterIDs[], locationID?, propIDs[] }
struct Page    { id, title, layoutPreset, panels[] }
struct ReferenceEntry { id, kind, name, aliases[], traits[], voiceNotes?, visualCues[], introducedPageIndex? }
struct Issue   { title, pages[] }
struct Focus   { pageID?, panelID?, referenceID? }
enum Mode { issue, page, panel, referencesAll, referenceDetail }
final class ModelController { model: Issue, mode, focus, issueVersion, ... mutating ops ... }
```

**Invariants:**
- Panel `order` in `balloons` is 1..N and strictly increasing.
- Page `panels` is the order used for export and thumbnails.
- `introducedPageIndex` is 0‑based; UI shows 1‑based.

### 2.3 Persistence
Project folder layout (human‑readable, git‑friendly):

```
SeriesName/
  issue.yaml               # issue metadata (title, page ordering)
  pages/page_###.yaml      # page -> panels -> balloons
  bible/characters.yaml    # ReferenceEntry (characters)
  bible/locations.yaml
  bible/props.yaml
  continuity.json          # derived flags + accepted exceptions (future)
  assets/
    thumbs/                # low‑fi page/panel thumbs
    panels/                # medium‑fi panel roughs
    refs/                  # reference portraits/thumbnails
  exports/
```

Serialization with `YAMLDecoder/Encoder` bridged via `Codable` (or JSON if simpler).

### 2.4 Chat Orchestration
- **Model:** Gemini Flash 2.5 (text).
- **Hidden `STATE_SUMMARY`** prepended every turn (mode, focus, short outline, focused page/panel snippet, bible snippet, allowed ops).  
- **System primer:** strict mode rules; prefer tool calls; no images in context; balloon budgets.
- **ToolRegistry:** function call surface for all allowed mutations + non‑mutating focus ops.  
- **Idempotency:** tools return a normalized event list and `issue_version` for optimistic concurrency.

**Flow (sequence):**

```
User text → buildMessages(state + primer + schema + history + user) 
   → Gemini → [tool calls]* or assistant text
     → invoke tools → update model → refresh state → UI updates
```

### 2.5 Tools (Function Surface)
Groups:
- **Focus:** `focus_issue|page|panel|reference`
- **Issue:** `add_page`, `remove_page`, `move_page`, `set_page_layout`, `regenerate_issue_thumbnails`
- **Page:** `add_panel`, `remove_panel`, `move_panel`, `regenerate_page_thumbnails`
- **Panel:** `update_panel_description`, `set_panel_role`, `add|update|remove_balloon`, `reorder_balloons`, `split_panel`, `set_panel_references`, `generate_panel_visual`
- **References:** `create_reference`, `update_reference`, `generate_reference_image`, `run_consistency_sweep`
- **Export:** `export_script`, `export_bible`

**Contract:** Tools mutate **ModelController**, bump `issueVersion`, emit events for UI.

### 2.6 Image Generation Queue
- **Engine:** Gemini Flash 2.5 Image (non‑blocking).  
- **Fidelity:** low‑fi for Issue/Page; medium‑fi for Panel/Reference Detail.  
- **Triggers:**
  - Page thumbnails: page created, **Regenerate**, or batch.
  - Panel rough: when description or references change, or **Generate Visual Rough**.
  - Reference image: on entry change or **Generate Portrait/Thumb**.
- **Caching Key (content hash):**
  - `SHA256(normalize(description) + join(characterIDs) + locationID + join(propIDs) + styleSeed + layoutPreset)`
  - Dialogue changes do **not** invalidate.
- **Queue policy:**
  - Max concurrent: configurable (e.g., 2–4). FIFO per scope (page/panel/ref).
  - Retries with backoff on transient errors; mark failed with error text.
- **Storage:**
  - `assets/panels/{panelID}-{hash}.png`
  - `assets/thumbs/{pageID}-{hash}.png`
  - `assets/refs/{refID}-{variant}-{hash}.png`
  - Symlink or index latest by panel/ref/page for quick lookup.

### 2.7 Continuity Engine
- **Inputs:** model, references, per‑panel description text.
- **Rules (v1 simple):**
  - Appears before introduction (`introducedPageIndex`).
  - Trait/visual cue contradictions (`dead`, `destroyed`, `cracked` vs “intact” in desc).
- **Outputs:** per‑panel array of human‑readable warnings; Page Mode shows **⚠ N**.
- **Future (v2):**
  - Rule DSL: `subject(scope=id) -> predicate(condition) -> severity -> hint`
  - Bible propagation (e.g., “visor repaired on p7” disables subsequent “cracked” warnings).  
  - Timeboxed states (from p2..p6).

### 2.8 Script Formatter / Parser
- **Formatter:** deterministic projection from model → text:
  ```
  Page N (K Panels)
  Panel 1: Description…
  Dialogue (Name): ...
  Thought (Name): ...
  Caption: ...
  SFX: KRAKOOM
  ```
- **Parser:** structure‑aware edits:
  - `Page N (K Panels)` edits page metadata and/or inserts/reorders with preview.
  - `Panel i:` edits description; missing panels auto‑grow page.
  - Balloon lines create/update balloons (`Dialogue|Thought|Caption|SFX`).
- **Diff & Renumber Preview:** before applying any renumbering, show a side‑by‑side diff; Undo is atomic.

### 2.9 Exporters
- **Script:** Markdown / PDF / Plain text (clean comic script; pages, panels, speakers, captions, SFX).
- **Contact Sheet:** optional page thumbnails sheet (low‑fi).
- **Bible:** Characters/Locations/Props summary (Markdown/PDF).

PDF via **PDFKit** (native) or HTML+WebKit print; Markdown using a simple renderer.

### 2.10 Settings
- Balloon word budget (default 22–25).
- Image concurrency; model temperature; style seed; privacy/offline mode.
- Mode persistence (last used), layout presets per project.

### 2.11 Error Handling & Undo
- All tool mutations are wrapped in a single Undo group.
- Image queue failures surface as badges with **Retry**.
- Chat tool errors return assistant text + minimal diagnostics; retry once with adjusted parameters.

---

## 3) Data Schemas

### 3.1 Page YAML (example)
```yaml
id: "p5"
title: "Pursuit"
layout_preset: "grid-6"
panels:
  - id: "pn1"
    description: "Wide shot of the asteroid belt…"
    role: "normal"
    character_ids: ["c_red_comet"]
    location_id: "l_belt"
    prop_ids: []
    balloons:
      - id: "b1"
        kind: "speech"
        speaker: "Red Comet"
        text: "Base, this might be my last flight."
        order: 1
  - id: "pn2"
    description: "Cockpit close-up…"
    role: "normal"
    character_ids: []
    location_id: "l_belt"
    prop_ids: []
    balloons: []
```

### 3.2 Reference YAML (character)
```yaml
- id: "c_red_comet"
  kind: "character"
  name: "Red Comet"
  aliases: []
  traits: ["stoic","fatalistic"]
  voice_notes: "Short, clipped, fatalistic humor."
  visual_cues: ["visor cracked since p2"]
  introduced_page_index: 0
```

### 3.3 Continuity JSON (future)
```json
{
  "accepted_exceptions": [
    { "id": "ex_001", "page_id": "p7", "panel_id": "pn3",
      "note": "Visor repaired in prior scene." }
  ]
}
```

---

## 4) Gemini Integration

### 4.1 Text Model (Chat)
- **Model:** Gemini Flash 2.5 (text).
- **Context packing:**  
  1) `STATE_SUMMARY_DO_NOT_ECHO` (system) — compact, current focus + outline + bible snippet  
  2) **System primer** — rules, tone, mode enforcement  
  3) **Tool schema** — compressed list or short JSON schema  
  4) **Visible history** — last N turns (e.g., 12)  
  5) **User message**  
- **No images** are sent to chat.

**Example system primer excerpt:**
```
- ISSUE MODE: pages only; no panels/balloons.
- PAGE MODE: panels only; no balloon edits.
- PANEL MODE: panel description/balloons/SFX; references; visuals allowed.
- REFERENCES: create/update entries; generate images.
- Prefer tool calls; keep balloons under budget.
```

### 4.2 Image Model
- **Model:** Gemini Flash 2.5 Image.
- **Prompt templates:**

Low‑fi page thumbnail (per panel)
```
STYLE: storyboard rough; broad shapes; minimal detail; no readable text
SERIES_STYLE: {style_seed}
SCENE: {panel_description}
SUBJECTS: characters={names}; location={name}; props={names}
NOTE: composition only; ignore dialogue; monochrome ok
```

Medium‑fi panel (detail)
```
STYLE: panel rough; clear silhouettes; indicate lighting and scale
SERIES_STYLE: {style_seed}
FOCUS: {panel_description}
SUBJECTS: characters={names with key traits}; location={name with cues}; props={names}
CONSTRAINTS: no speech balloons; allow diegetic signage if specified
```

**Transport:** async queue; results saved to disk; UI listens for completion.

---

## 5) Algorithms & Key Flows

### 5.1 Content Hash (images)
```swift
func panelHash(panel: Panel, page: Page, style: String) -> String {
    let parts = [
        normalize(panel.description),
        panel.characterIDs.sorted().joined(separator: ","),
        panel.locationID ?? "",
        panel.propIDs.sorted().joined(separator: ","),
        page.layoutPreset,
        style
    ]
    return sha256(parts.joined(separator: "|"))
}
```

`normalize` trims whitespace, lowercases, collapses numbers, strips punctuation that doesn’t affect composition.

### 5.2 Mode Enforcement (tools)
```swift
func guardMode(_ needed: Mode, current: Mode) throws {
    let ok: Bool =
      (needed == .issue && current == .issue) ||
      (needed == .page && current == .page) ||
      (needed == .panel && current == .panel) ||
      (needed == .referencesAll && current == .referencesAll) ||
      (needed == .referenceDetail && current == .referenceDetail)
    if !ok { throw ToolError(code: "disallowed_in_mode", message: "\(current)") }
}
```

### 5.3 Script Parser (delta apply)
- Tokenize lines; detect headers (`Page N (K Panels)`), panel starts (`Panel i:`), balloon lines.
- Build a mutation plan (insert/rename/renumber/edit).
- Preview → apply as one Undo group → bump version.

### 5.4 Continuity (demo rules pseudocode)
```swift
for panel in page.panels {
  warns = []
  for id in panel.characterIDs {
    r = refByID(id)
    if r.introducedPageIndex != nil && pageIndex < r.introducedPageIndex! { warns += "before intro" }
    if r.traits.contains("dead") { warns += "marked dead" }
  }
  if let lid = panel.locationID { ... before-intro check ... }
  for pid in panel.propIDs {
    r = refByID(pid)
    if r.visualCues.contains("destroyed") { warns += "destroyed" }
    if r.visualCues.contains("cracked") && panel.description.contains("intact") { warns += "cracked vs intact" }
  }
}
```

---

## 6) Concurrency, Threads, and Undo

- **Model mutations** happen on main thread via `ModelController`; Undo groups wrap tool calls and Script delta applies.
- **Image queue** runs off main; publishes back to main with `@MainActor` updates.
- **Chat calls** are async; tool invocations are awaited, then coalesced into a single assistant message (“Applied N change(s)”) to keep history compact.

---

## 7) Performance Targets

- Open project with 50 pages / 300 panels: < 150ms to render Script; < 60ms for Page Mode grid.
- Image queue: 2–4 concurrent requests; UI stays responsive; thumbnails arrive progressively.
- Chat turn packing: `STATE_SUMMARY` < 2 KB typical; visible history ≤ 12 turns; per‑turn tokens bounded.

Optimization knobs: lazy Script rendering, on‑screen panel virtualization, diff‑aware formatter, incremental YAML writes.

---

## 8) Security & Privacy

- **API Keys:** stored in Keychain; never written to project files.
- **Offline Mode:** chat and image tools disabled; all editing still available.
- **Local Files:** all project data in user‑selected folder; sandboxed; no background uploads.
- **Telemetry:** off by default (if added later, aggregate anonymized metrics only).

---

## 9) Testing Strategy

- **Unit:**  
  - Script parser (headers, panel edits, balloon creation).  
  - Continuity rules (before‑intro, trait contradictions).  
  - Content hash stability (same input → same hash; different input → diff hash).
- **Integration:**  
  - Tool sequences (add page → add panel → add balloon → export).  
  - Chat orchestrator: mock tool calls resolved and model mutated.
- **UI:** snapshot tests for Page Mode chips and warning badges (with predictable fixtures).
- **Perf:** load a synthetic 300‑panel project and assert render/scroll budgets.

---

## 10) Roadmap

**0.1 (scaffold / demo — DONE)**
- Swift Package **ComicSmithCore** (Model, Tools, Chat orchestrator, State summary, Primer).
- Demo app with **Issue/Page/Panel/Refs** views, Script pane, mock chat client.
- Reference pickers and live chips in Page Mode.
- Image queue stub with **Generating…** badges.
- Continuity checker (simple rules).

**0.2 (MVP)**
- Real Gemini clients (text + image), API settings UI.
- Disk persistence (YAML/JSON) + Autosave.
- Image cache with content hash + directory cleanup.
- Markdown/PDF export via PDFKit.
- Script parser full surface (balloons + renumber preview).
- Settings panel (balloon budget, style seed, concurrency).

**0.3**
- Continuity v2 (exceptions, timeboxed states, rule severity).
- Contact sheet export; Bible export.
- Better Page Mode layout (grid presets, drag‑reorder with ghosting).

**0.4**
- Undo/redo polish across all tools; batch chat tool sequences as a single undo step.
- Accessibility (VoiceOver labels for chips, warnings, and buttons).
- Basic search across script and references.

**Later**
- Project templates, multi‑issue library, cross‑issue continuity, importer for existing scripts.

---

## 11) Open Questions & Decisions

- **PDF renderer:** PDFKit (native) vs HTML→PDF (more styling control). *Leaning PDFKit for v1.*
- **State summary compaction:** Use IDs + hashes for unchanged pages to shave tokens; include only ±2 panels around focus in Panel Mode.
- **Exports with images:** Keep script text and images separate for v1; allow optional **contact sheet** add‑on.
- **Page thumbnails source:** Compose from panel roughs vs ask image model for page‑level summary. *Start with per‑panel → stitch.*

---

## 12) Appendix

### 12.1 Tool Result Event Types (examples)
```json
{ "type": "page_added",           "payload": { "page_id": "p7" } }
{ "type": "panel_added",          "payload": { "page_id": "p7", "panel_id": "pn3" } }
{ "type": "panel_desc_updated",   "payload": { "page_id": "p7", "panel_id": "pn3" } }
{ "type": "balloon_added",        "payload": { "panel_id": "pn3", "balloon_id": "b9" } }
{ "type": "panel_refs_set",       "payload": { "panel_id": "pn3" } }
{ "type": "gen_panel_visual",     "payload": {} }
{ "type": "regen_page_thumbs",    "payload": {} }
```

### 12.2 Minimal Script Grammar (v1)
```
Script      ::= { Page }
Page        ::= "Page" INT "(" INT "Panels" ")" NL { Panel } NL
Panel       ::= "Panel" INT ":" TEXT NL { Balloon }
Balloon     ::= ("Dialogue"|"Thought") "(" NAME ")" ":" TEXT NL
              | "Caption:" TEXT NL
              | "SFX:" TEXT NL
```

### 12.3 ASCII View Map
```
+-------------------+ +-------------------------+ +--------------------+
|       Chat        | |        Content          | |       Script       |
| brainstorm ↔ diff | | Issue | Page | Panel |R | | live editable text |
+-------------------+ +-------------------------+ +--------------------+
```

---

**End of document.**
